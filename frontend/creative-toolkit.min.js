"use strict";var CreativeToolkit=(()=>{var T=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var M=(e,o)=>{for(var t in o)T(e,t,{get:o[t],enumerable:!0})},K=(e,o,t,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of Y(o))!X.call(e,r)&&r!==t&&T(e,r,{get:()=>o[r],enumerable:!(n=A(o,r))||n.enumerable});return e};var G=e=>K(T({},"__esModule",{value:!0}),e);var O={};M(O,{Canvas:()=>C,EventEmitter:()=>u,addCommand:()=>P,brush:()=>R,calculateEraseIntensity:()=>H,calculateStrokeStats:()=>g,canRedo:()=>S,canUndo:()=>E,clearHistory:()=>W,core:()=>B,createBrushStroke:()=>m,createEraserStroke:()=>b,createHistory:()=>f,drawBrushStroke:()=>y,drawEraserStroke:()=>x,eraser:()=>z,getRegion:()=>p,interpolateStroke:()=>d,redo:()=>w,undo:()=>k});var u=class{constructor(){this.events=new Map}on(o,t){this.events.has(o)||this.events.set(o,[]),this.events.get(o).push(t)}off(o,t){let n=this.events.get(o);if(n){let r=n.indexOf(t);r>-1&&n.splice(r,1)}}emit(o,t){let n=this.events.get(o);n&&n.forEach(r=>r(t))}clear(){this.events.clear()}};var R={};M(R,{createBrushStroke:()=>m,drawBrushStroke:()=>y});function d(e,o=.5){if(e.length<2||o===0)return e;let t=[];t.push(e[0]);for(let n=0;n<e.length-1;n++){let r=e[Math.max(0,n-1)],s=e[n],i=e[n+1],a=e[Math.min(e.length-1,n+2)],h=Math.hypot(i.x-s.x,i.y-s.y),c=Math.max(2,Math.floor(h*o*.5));for(let l=0;l<c;l++){let D=l/c;t.push(J(r,s,i,a,D))}}return t.push(e[e.length-1]),t}function J(e,o,t,n,r){let s=r*r,i=s*r,a=.5*(2*o.x+(-e.x+t.x)*r+(2*e.x-5*o.x+4*t.x-n.x)*s+(-e.x+3*o.x-3*t.x+n.x)*i),h=.5*(2*o.y+(-e.y+t.y)*r+(2*e.y-5*o.y+4*t.y-n.y)*s+(-e.y+3*o.y-3*t.y+n.y)*i),c=o.pressure&&t.pressure?o.pressure+(t.pressure-o.pressure)*r:o.pressure||t.pressure;return{x:a,y:h,pressure:c}}function p(e,o,t,n){let r=e/t,s=o/n,i=r<.33?"left":r>.67?"right":"center",a=s<.33?"top":s>.67?"bottom":"";return a===""?i:`${a}-${i}`}function g(e){if(e.length<2)return{length:0,duration:0,speed:0};let o=0;for(let r=1;r<e.length;r++){let s=e[r].x-e[r-1].x,i=e[r].y-e[r-1].y;o+=Math.hypot(s,i)}let t=(e[e.length-1].timestamp||0)-(e[0].timestamp||0),n=t>0?o/t:0;return{length:o,duration:t,speed:n}}function y(e,o,t){if(o.points.length<2)return;let n=d(o.points,t.smoothing);e.save(),e.strokeStyle=t.color,e.globalAlpha=t.opacity,e.lineCap="round",e.lineJoin="round";for(let r=1;r<n.length;r++){let s=n[r-1],i=n[r],a=s.pressure||.5,h=i.pressure||.5,c=t.thickness*((a+h)/2);e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(i.x,i.y),e.lineWidth=c,e.stroke()}e.restore()}function m(e,o,t,n){let r=g(e),s=e[Math.floor(e.length/2)],i=p(s.x,s.y,t,n);return{id:`stroke-${Date.now()}-${Math.random()}`,tool:"brush",points:e,color:o.color,thickness:o.thickness,timestamp:Date.now(),duration:r.duration,length:r.length,speed:r.speed,region:i}}var z={};M(z,{calculateEraseIntensity:()=>H,createEraserStroke:()=>b,drawEraserStroke:()=>x});function x(e,o,t){if(o.points.length<2)return;let n=d(o.points,t.smoothing);e.save(),e.globalCompositeOperation="destination-out",e.strokeStyle="rgba(0, 0, 0, 1)",e.lineCap="round",e.lineJoin="round";for(let r=1;r<n.length;r++){let s=n[r-1],i=n[r],a=s.pressure||.7,h=i.pressure||.7,c=t.thickness*((a+h)/2)*1.5;e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(i.x,i.y),e.lineWidth=c,e.stroke()}e.restore()}function b(e,o,t,n){let r=g(e),s=e[Math.floor(e.length/2)],i=p(s.x,s.y,t,n);return{id:`eraser-${Date.now()}-${Math.random()}`,tool:"eraser",points:e,color:"transparent",thickness:o.thickness,timestamp:Date.now(),duration:r.duration,length:r.length,speed:r.speed,region:i}}function H(e){let o=e.length*e.thickness;return e.duration>0?o/e.duration:0}function f(){return{past:[],present:null,future:[]}}function P(e,o){return{past:e.present?[...e.past,e.present]:e.past,present:o,future:[]}}function k(e){if(!e.present&&e.past.length===0)return e;let o=[...e.past],t=o.pop()||null,n=e.present?[e.present,...e.future]:e.future;return{past:o,present:t,future:n}}function w(e){if(e.future.length===0)return e;let o=[...e.future],t=o.shift()||null;return{past:e.present?[...e.past,e.present]:e.past,present:t,future:o}}function W(){return f()}function E(e){return e.present!==null||e.past.length>0}function S(e){return e.future.length>0}var C=class extends u{constructor(t){super();this.currentTool="brush";this.isDrawing=!1;this.currentPoints=[];this.history=f();this.drawingMode="baseline";this.suggestedWords=["help","please","eat","save me","stop","why","listen","understand","see me","files","no","yes","hello","know","let me","need","want","take"];this.currentPrediction=null;this.predictionStartIndex=0;this.config={brush:{type:"brush",color:"#ffffff",thickness:8,opacity:1,smoothing:.7},eraser:{type:"eraser",color:"transparent",thickness:20,opacity:1,smoothing:.5},pen:{type:"pen",color:"#ffffff",thickness:2,opacity:1,smoothing:.7},stamp:{type:"stamp",color:"#ffffff",thickness:1,opacity:1,smoothing:0},tear:{type:"tear",color:"transparent",thickness:15,opacity:1,smoothing:.3}};this.canvasElement=t;let n=t.getContext("2d");if(!n)throw new Error("Failed to get 2D context from canvas");this.ctx=n;let r=window.devicePixelRatio||1,s=t.clientWidth,i=t.clientHeight;t.width=s*r,t.height=i*r,this.ctx.scale(r,r),this.setupEventListeners()}setupEventListeners(){this.canvasElement.addEventListener("pointerdown",t=>this.handlePointerDown(t)),this.canvasElement.addEventListener("pointermove",t=>this.handlePointerMove(t)),this.canvasElement.addEventListener("pointerup",t=>this.handlePointerUp(t)),this.canvasElement.addEventListener("pointercancel",t=>this.handlePointerUp(t)),document.addEventListener("keydown",t=>this.handleKeyDown(t))}handlePointerDown(t){if(t.button!==0)return;this.isDrawing=!0,this.currentPoints=[];let n=this.canvasElement.getBoundingClientRect(),r=t.clientX-n.left,s=t.clientY-n.top,i=t.pressure||.5;this.currentPoints.push({x:r,y:s,pressure:i})}handlePointerMove(t){if(!this.isDrawing)return;let n=this.canvasElement.getBoundingClientRect(),r=t.clientX-n.left,s=t.clientY-n.top,i=t.pressure||.5;if(this.currentPoints.push({x:r,y:s,pressure:i}),this.currentPoints.length>=2){let a=this.currentPoints.slice(-2),h=this.processPoints(a),c=this.config[this.currentTool];if(this.currentTool==="brush"){let l=a.length>=2?Math.hypot(a[1].x-a[0].x,a[1].y-a[0].y):0,D=a[0].pressure||.5,I=a[1]?.pressure||.5,$=(D+I)/2,F=this.getAdaptiveThickness(l,$),U={id:`temp-${Date.now()}`,tool:"brush",points:h,color:c.color,thickness:F,timestamp:Date.now(),duration:0,length:0,speed:0,region:"center"};if(y(this.ctx,U,c),this.drawingMode==="fuzzy-predict"||this.drawingMode==="aggressive-predict"){let L=this.getDrawnPathLength(this.currentPoints),v=this.predictWord(L);v&&v!==this.currentPrediction&&(this.currentPrediction=v,this.predictionStartIndex=this.currentPoints.length,console.log("[Prediction] Suggesting:",v,"at path length:",L),this.currentPoints.length>0&&this.renderPredictionGhost(v,this.currentPoints[this.currentPoints.length-1]))}}else if(this.currentTool==="eraser"){let l={id:`temp-${Date.now()}`,tool:"eraser",points:h,color:"transparent",thickness:c.thickness,timestamp:Date.now(),duration:0,length:0,speed:0,region:"center"};x(this.ctx,l,c)}}}handlePointerUp(t){if(!this.isDrawing||this.currentPoints.length<2){this.isDrawing=!1,this.currentPoints=[];return}this.isDrawing=!1;let n=this.config[this.currentTool],r=this.processPoints(this.currentPoints),s;if(this.currentTool==="brush"?s=m(r,n,this.canvasElement.clientWidth,this.canvasElement.clientHeight):s=b(r,n,this.canvasElement.clientWidth,this.canvasElement.clientHeight),(this.drawingMode==="fuzzy-predict"||this.drawingMode==="aggressive-predict")&&this.currentPrediction&&this.currentTool==="brush"){let a=this.currentPoints[this.currentPoints.length-1],h=this.smoothDrawPredictedText(this.currentPrediction,a);h.length>0&&(this.currentPoints.push(...h),s=m(this.currentPoints,n,this.canvasElement.clientWidth,this.canvasElement.clientHeight))}let i={type:this.currentTool==="brush"?"stroke":"erase",data:s,timestamp:s.timestamp};if(P(this.history,i),this.currentTool==="brush"){let a={stroke:s,speed:s.speed,pressure:this.currentPoints.reduce((h,c)=>h+(c.pressure||.5),0)/this.currentPoints.length,region:s.region,frantic:s.speed>3,calm:s.speed<1};this.emit("draw",a)}else{let a={region:s.region,intensity:Math.min(1,s.length/1e3),aggressive:s.speed>2};this.emit("erase",a)}this.currentPrediction=null,this.currentPoints=[]}handleKeyDown(t){t.key==="d"||t.key==="D"?this.selectTool("brush"):t.key==="e"||t.key==="E"?this.selectTool("eraser"):t.key==="z"||t.key==="Z"?E(this.history)&&(k(this.history),this.redraw()):(t.key==="y"||t.key==="Y")&&S(this.history)&&(w(this.history),this.redraw())}selectTool(t){this.currentTool=t,this.updateCursor(),this.emit("toolChanged",{tool:t})}setDrawingMode(t){this.drawingMode=t,this.emit("modeChanged",{mode:t})}stabilizeStroke(t){if(t.length<3)return t;let n=[];for(let r=0;r<t.length;r++)if(r===0)n.push(t[0]);else if(r===t.length-1)n.push(t[t.length-1]);else{let s=t[r-1],i=t[r],a=t[r+1];n.push({x:(s.x+i.x+a.x)/3,y:(s.y+i.y+a.y)/3,pressure:i.pressure,timestamp:i.timestamp})}return n}getAdaptiveThickness(t,n){let r=this.config[this.currentTool].thickness;if(this.drawingMode==="pressure-sensitive"){let s=Math.max(.5,Math.min(1.5,1.5-t*.05)),i=n||1;return r*s*i}return r}processPoints(t){return this.drawingMode==="baseline"||this.drawingMode==="heavy-smooth"?t:this.drawingMode==="stabilized"?this.stabilizeStroke(t):(this.drawingMode==="pressure-sensitive"||this.drawingMode==="fuzzy-predict"||this.drawingMode==="aggressive-predict",t)}predictWord(t){for(let r of this.suggestedWords)if(this.drawingMode==="fuzzy-predict"){let s=Math.ceil(r.length*.4);if(t>=s)return r}else if(this.drawingMode==="aggressive-predict"){let s=Math.ceil(r.length*.2);if(t>=s)return r}return null}getDrawnPathLength(t){if(t.length<2)return 0;let n=0;for(let r=1;r<t.length;r++){let s=t[r].x-t[r-1].x,i=t[r].y-t[r-1].y;n+=Math.hypot(s,i)}return Math.floor(n/20)}renderPredictionGhost(t,n){let r=this.drawingMode==="aggressive-predict"?.35:.15;this.ctx.save(),this.ctx.globalAlpha=r,this.ctx.fillStyle=this.config.brush.color,this.ctx.font='32px "Byron Mark I", serif',this.ctx.textBaseline="alphabetic",this.ctx.fillText(t,n.x+15,n.y+8),this.ctx.restore()}smoothDrawPredictedText(t,n){let r=[];this.ctx.save(),this.ctx.font='32px "Byron Mark I", serif';let s=n.x+15,i=n.y+8;for(let a of t){let c=this.ctx.measureText(a).width;for(let l=0;l<5;l++)r.push({x:s+l/5*c,y:i,pressure:.7});s+=c}return this.ctx.restore(),r}updateCursor(){this.currentTool==="brush"?this.canvasElement.style.cursor="crosshair":this.canvasElement.style.cursor="cell"}redraw(){this.ctx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height)}setColor(t){this.config.brush.color=t}getCanvasState(){return this.ctx.getImageData(0,0,this.canvasElement.width,this.canvasElement.height)}loadCanvasState(t){this.ctx.putImageData(t,0,0)}clear(){this.ctx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.history=f()}};var B={};return G(O);})();
